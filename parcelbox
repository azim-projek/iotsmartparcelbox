// Smart Parcel Box - ESP32 + Keypad + Servo + Ultrasonic + Telegram + Door Lock

#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <UniversalTelegramBot.h>
#include <ESP32Servo.h>
#include <Keypad.h>

// === WiFi & Telegram Settings ===
const char* WIFI_SSID = "realme GT NEO 3";
const char* WIFI_PASS = "miskinsangatke";
#define BOT_TOKEN "8259717729:AAGfa-sK4DOhWsJcyrXl2sO_QODNMwDc6wI"
#define CHAT_ID   "1034103142"

WiFiClientSecure client;
UniversalTelegramBot bot(BOT_TOKEN, client);

// === Ultrasonic Sensor Pins ===
#define TRIG_PIN 16
#define ECHO_PIN 34

// === Servo Pins ===
#define SERVO_DROP 17     // Top servo (drop door)
#define SERVO_DOOR 18     // Bottom servo (parcel door)

// === Door Lock Pin ===
#define LOCK_PIN 19       // Relay/transistor controlling electrical lock

Servo dropServo;
Servo doorServo;

// === Keypad Setup ===
const byte ROWS = 4;
const byte COLS = 4;
char keys[ROWS][COLS] = {
  {'1','2','3','A'},
  {'4','5','6','B'},
  {'7','8','9','C'},
  {'*','0','#','D'}
};

byte rowPins[ROWS] = {27, 14, 12, 13};
byte colPins[COLS] =  {32, 33, 25, 26};
Keypad keypad = Keypad(makeKeymap(keys), rowPins, colPins, ROWS, COLS);

// === Variables ===
long duration;
int distance;
const int threshold = 15;  // cm
bool parcelDetected = false;

String correctPassword = "1234";   // Default password
String enteredPassword = "";
unsigned long lastCheckTime = 0;
const unsigned long TELEGRAM_CHECK_INTERVAL = 2000;

// === Read Ultrasonic ===
int readUltrasonic() {
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);
  duration = pulseIn(ECHO_PIN, HIGH, 30000);
  return duration * 0.034 / 2;
}

// === Servo Movement Function ===
void moveServo(Servo &servo, int angle, int delayTime = 1000) {
  servo.write(angle);
  delay(delayTime);
  servo.write(90);  // stop / neutral for continuous servo
}

// === Move both servos together ===
void moveBothServos() {
  dropServo.write(90);
  doorServo.write(90);
  delay(3000);  // both servos stay at 90° for 3 seconds
  dropServo.write(0);   // return to normal position
  doorServo.write(0);
}

// === Telegram Command Handling ===
void handleNewMessages(int numNewMessages) {
  for (int i = 0; i < numNewMessages; i++) {
    String chat_id = String(bot.messages[i].chat_id);
    String text = bot.messages[i].text;
    if (chat_id != CHAT_ID) continue;

    if (text.startsWith("/setpass ")) {
      String newPass = text.substring(9);
      if (newPass.length() >= 4 && newPass.length() <= 8) {
        correctPassword = newPass;
        bot.sendMessage(CHAT_ID, "🔑 Password updated to: " + correctPassword, "");
      } else {
        bot.sendMessage(CHAT_ID, "❌ Invalid password length (4-8 digits).", "");
      }
    } else if (text == "/getpass") {
      bot.sendMessage(CHAT_ID, "🔐 Current password: " + correctPassword, "");
    } else if (text == "/help") {
      bot.sendMessage(CHAT_ID,
        "📋 *Smart Parcel Box Commands:*\n"
        "/setpass <newpass> - Change password\n"
        "/getpass - Show current password\n"
        "/help - Show command list",
        "Markdown");
    }
  }
}

// === Setup ===
void setup() {
  Serial.begin(115200);

  // WiFi connection
  WiFi.begin(WIFI_SSID, WIFI_PASS);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\n✅ WiFi Connected");
  client.setInsecure();

  // Pin setup
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  pinMode(LOCK_PIN, OUTPUT);
 digitalWrite(LOCK_PIN, LOW); // lock initially


  // Servo setup
  dropServo.attach(SERVO_DROP);
  doorServo.attach(SERVO_DOOR);
  dropServo.write(0);
  doorServo.write(0);

  bot.sendMessage(CHAT_ID, "📦 Smart Parcel Box System Online!\nUse /help for commands.", "");
}

// === Loop ===
void loop() {
  distance = readUltrasonic();
  Serial.print("Distance: ");
  Serial.print(distance);
  Serial.println(" cm");

  // Detect parcel with ultrasonic
  if (distance > 0 && distance < threshold && !parcelDetected) {
    parcelDetected = true;
    bot.sendMessage(CHAT_ID, "📦 Parcel detected! Dropping into storage...", "");

    moveBothServos();  // ✅ both servos move together for 3 sec

    bot.sendMessage(CHAT_ID, "✅ Parcel safely stored!", "");
  }

  // === Keypad Password Entry ===
  char key = keypad.getKey();
  if (key) {
    Serial.print("Key pressed: ");
    Serial.println(key);

    if (key == '#') {
      enteredPassword.trim();
      correctPassword.trim();

      if (enteredPassword == correctPassword) {
      Serial.println("✅ Correct password!");
      bot.sendMessage(CHAT_ID, "🔓 Correct password! Unlocking door...", "");

      // ✅ Turn relay ON (unlock)
      digitalWrite(LOCK_PIN, HIGH);
      delay(3000);  // keep unlocked for 3 seconds

      // 🔒 Then lock again
      digitalWrite(LOCK_PIN, LOW);
      bot.sendMessage(CHAT_ID, "📭 Door locked again.", "");
  } else {
        Serial.println("❌ Wrong password!");
        bot.sendMessage(CHAT_ID, "❌ Wrong password!", "");
      }

      enteredPassword = ""; // reset
    } 
    else if (key == '*') {
      enteredPassword = "";
      Serial.println("Password cleared.");
    } 
    else {
      enteredPassword += key;
      Serial.print("Entered so far: ");
      Serial.println(enteredPassword);
    }
  }

  // === Telegram message check ===
  if (millis() - lastCheckTime > TELEGRAM_CHECK_INTERVAL) {
    int numNewMessages = bot.getUpdates(bot.last_message_received + 1);
    while (numNewMessages) {
      handleNewMessages(numNewMessages);
      numNewMessages = bot.getUpdates(bot.last_message_received + 1);
    }
    lastCheckTime = millis();
  }

  delay(150);
}
